import os
import base64
from io import BytesIO

import streamlit as st
from openai import OpenAI
from PIL import Image

# --- OpenAI í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (ê³µë°± ì œê±° ë°©ì–´) ---
raw_key = os.getenv("OPENAI_API_KEY") or ""
api_key = raw_key.strip()

client = OpenAI(api_key=api_key)

# --- Streamlit ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(page_title="gpt-image-1 ë°ëª¨", page_icon="ğŸ¨")
st.title("ğŸ¨ gpt-image-1 ì´ë¯¸ì§€ ë°ëª¨")

if not api_key:
    st.error("í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì•„ìš”. í„°ë¯¸ë„ì—ì„œ export í•´ì£¼ì„¸ìš”.")
    st.stop()

tab_gen, tab_edit = st.tabs(["âœ¨ í…ìŠ¤íŠ¸ë¡œ ìƒˆë¡œ ìƒì„±", "ğŸŒ€ ì´ë¯¸ì§€ ë³€í˜•(í¸ì§‘)"])

# =========================================
# 1ï¸âƒ£ í…ìŠ¤íŠ¸ â†’ ìƒˆ ì´ë¯¸ì§€ ìƒì„±
# =========================================
with tab_gen:
    st.subheader("í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¡œ ìƒˆ ì´ë¯¸ì§€ ë§Œë“¤ê¸°")

    prompt = st.text_area(
        "ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸",
        value="a cute chibi game character holding a glowing sword, anime style",
        height=100,
    )

    col1, col2 = st.columns(2)
    with col1:
        size = st.selectbox(
            "ì´ë¯¸ì§€ í¬ê¸°",
            ["auto", "1024x1024", "1024x1536", "1536x1024"],
            index=1,
        )
    with col2:
        quality = st.selectbox(
            "í€„ë¦¬í‹°",
            ["auto", "low", "medium", "high"],
            index=2,
        )

    if st.button("ğŸ–¼ï¸ ìƒˆ ì´ë¯¸ì§€ ìƒì„±", type="primary"):
        if not prompt.strip():
            st.error("í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
        else:
            with st.spinner("ì´ë¯¸ì§€ ìƒì„± ì¤‘..."):
                try:
                    result = client.images.generate(
                        model="gpt-image-1",
                        prompt=prompt,
                        size=size,
                        quality=quality,
                        n=1,
                    )

                    image_base64 = result.data[0].b64_json
                    image_bytes = base64.b64decode(image_base64)
                    img = Image.open(BytesIO(image_bytes))

                    st.success("ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!")
                    st.image(img, caption="generated by gpt-image-1", use_column_width=True)
                    st.download_button(
                        "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (PNG)",
                        data=image_bytes,
                        file_name="generated_image.png",
                        mime="image/png",
                    )
                except Exception as e:
                    st.error(f"ì—ëŸ¬ ë°œìƒ: {type(e).__name__} - {e}")

# =========================================
# 2ï¸âƒ£ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ â†’ ë³€í˜•(í¸ì§‘)
# =========================================
with tab_edit:
    st.subheader("ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ í”„ë¡¬í”„íŠ¸ë¡œ ë³€í˜•í•˜ê¸°")

    uploaded_file = st.file_uploader(
        "ë³€í˜•í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (PNG / JPG / JPEG / WEBP)",
        type=["png", "jpg", "jpeg", "webp"],
    )

    if uploaded_file is not None:
        # ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— ë¯¸ë¦¬ë³´ê¸°
        bytes_data = uploaded_file.getvalue()
        st.image(bytes_data, caption="ì›ë³¸ ì´ë¯¸ì§€", use_column_width=True)

        edit_prompt = st.text_area(
            "ì´ ì´ë¯¸ì§€ë¥¼ ì–´ë–»ê²Œ ë°”ê¾¸ê³  ì‹¶ì€ì§€ ì„¤ëª…í•´ ì£¼ì„¸ìš”",
            value="turn this character into a dark mage with purple flames around them",
            height=100,
        )

        # ì„ íƒì ìœ¼ë¡œ input fidelity ê°™ì€ ì˜µì…˜ì„ ë‚˜ì¤‘ì— ì¶”ê°€í•  ìˆ˜ ìˆìŒ
        if st.button("ğŸŒ€ ì´ ì´ë¯¸ì§€ ë³€í˜•í•˜ê¸°"):
            if not edit_prompt.strip():
                st.error("ë³€í˜• í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
            else:
                with st.spinner("ì´ë¯¸ì§€ í¸ì§‘ ì¤‘..."):
                    try:
                        # 1) ì—…ë¡œë“œëœ ë°”ì´íŠ¸ â†’ PIL ì´ë¯¸ì§€ë¡œ ì—´ê¸°
                        original_img = Image.open(BytesIO(bytes_data)).convert("RGBA")

                        # 2) ë‹¤ì‹œ PNGë¡œ ì¸ë©”ëª¨ë¦¬ ì €ì¥
                        img_buffer = BytesIO()
                        original_img.save(img_buffer, format="PNG")
                        img_buffer.seek(0)

                        # 3) íŒŒì¼ ì´ë¦„(í™•ì¥ì)ë¥¼ ê°•ì œë¡œ ë‹¬ì•„ì£¼ê¸° â†’ mimetype ì¸ì‹ìš©
                        img_buffer.name = "image.png"

                        # 4) gpt-image-1 í¸ì§‘ í˜¸ì¶œ
                        result = client.images.edit(
                            model="gpt-image-1",
                            image=img_buffer,
                            prompt=edit_prompt,
                            # í•„ìš”í•˜ë©´ ì˜µì…˜ ì¶”ê°€ ê°€ëŠ¥:
                            # size="1024x1024",
                            # quality="high",
                        )

                        image_base64 = result.data[0].b64_json
                        edited_bytes = base64.b64decode(image_base64)
                        edited_img = Image.open(BytesIO(edited_bytes))

                        st.success("ì´ë¯¸ì§€ ë³€í˜• ì™„ë£Œ!")
                        st.image(
                            edited_img,
                            caption="edited by gpt-image-1",
                            use_column_width=True,
                        )
                        st.download_button(
                            "ë³€í˜•ëœ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (PNG)",
                            data=edited_bytes,
                            file_name="edited_image.png",
                            mime="image/png",
                        )
                    except Exception as e:
                        st.error(f"ì—ëŸ¬ ë°œìƒ: {type(e).__name__} - {e}")
    else:
        st.info("ìœ„ì— ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ ì—…ë¡œë“œí•˜ë©´, ì—¬ê¸°ì„œ í”„ë¡¬í”„íŠ¸ë¡œ ë³€í˜•í•  ìˆ˜ ìˆì–´ìš”.")
